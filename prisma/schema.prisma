// Prisma Schema for VoDeMe Authentication System
// Database: Neon PostgreSQL
// Prisma 7 with Driver Adapter

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model - Core user information
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String?  @unique
  name      String

  // Password storage (hashed with Argon2id)
  // NOTE: Nullable for OAuth-only users (e.g., Google sign-in)
  passwordHash String?

  // Profile information
  profilePicture String? // UploadThing URL or OAuth provider URL

  // Account status and verification
  status        String   @default("active") // active, suspended, deleted
  emailVerified DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sessions        Session[]
  auditLogs       AuditLog[]
  accounts        Account[] // OAuth provider accounts
  lessonProgress  LessonProgress[]
  quizAttempts    QuizAttempt[]
  learningWallPosts LearningWallPost[]
  learningWallLikes LearningWallLike[]
  gameProgress    GameProgress[]

  @@index([email])
  @@index([username])
  @@map("users")
}

// Session Model - Server-side session management
model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Session metadata
  ipAddress String?
  userAgent String?

  // Expiration
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

// Verification Token Model - Email verification and password resets
model VerificationToken {
  id    String   @id @default(cuid())
  email String
  token String   @unique
  type  String   // "email_verify", "password_reset"

  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([email])
  @@index([token])
  @@index([type])
  @@map("verification_tokens")
}

// Audit Log Model - Security and compliance tracking
model AuditLog {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Action details
  action    String // "login", "logout", "password_change", "email_change", "profile_update"
  entity    String // "user", "profile", "session"
  entityId  String

  // Change tracking
  oldData Json?
  newData Json?

  // Request metadata
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// Account Model - OAuth provider linkage for multi-auth support
model Account {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Provider information
  provider          String   // "google", "facebook", "github", etc.
  providerAccountId String   // Provider's user ID (e.g., Google's sub)

  // OAuth tokens (store encrypted in production)
  accessToken       String?  @db.Text
  refreshToken      String?  @db.Text
  expiresAt         DateTime?
  tokenType         String?
  scope             String?

  // Provider profile data (name, email, picture, etc.)
  providerData      Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, providerAccountId])
  @@unique([userId, provider]) // One account per provider per user
  @@index([userId])
  @@map("accounts")
}

// OAuthState Model - CSRF protection for OAuth flow
model OAuthState {
  id          String   @id @default(cuid())
  state       String   @unique
  provider    String   // "google", "facebook", etc.
  mode        String   // "signin" or "link"
  userId      String?  // For link mode, track which user is linking
  redirectUri String?  // Post-auth redirect destination

  expiresAt   DateTime // State tokens expire in 10 minutes
  createdAt   DateTime @default(now())

  @@index([state])
  @@index([expiresAt])
  @@map("oauth_states")
}

// VideoLesson Model - Stores video lesson information
model VideoLesson {
  id          String   @id @default(cuid())
  title       String
  description String   @db.Text
  videoUrl    String   // Video file URL
  duration    Int      // Duration in seconds
  level       Int      // Lesson level (1, 2, 3, etc.)
  order       Int      // Display order within the level

  // Relations
  quiz       Quiz?
  progress   LessonProgress[]
  learningWallPosts LearningWallPost[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([level, order]) // Ensure unique ordering within each level
  @@index([level])
  @@map("video_lessons")
}

// LessonProgress Model - Tracks user progress on each lesson
model LessonProgress {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId        String
  lesson          VideoLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  // Progress tracking
  completed       Boolean  @default(false)
  watchedDuration Int      @default(0) // Seconds watched (for resume functionality)
  completedAt     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@map("lesson_progress")
}

// Quiz Model - Stores quiz questions and settings
model Quiz {
  id           String   @id @default(cuid())
  lessonId     String   @unique
  lesson       VideoLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  title        String
  questions    Json     // Array of questions with options and correct answers
  passingScore Int      @default(70) // Percentage required to pass

  // Relations
  attempts     QuizAttempt[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("quizzes")
}

// QuizAttempt Model - Tracks user quiz attempts
model QuizAttempt {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quizId      String
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  score       Int      // Score as percentage (0-100)
  answers     Json     // User's answers for review
  passed      Boolean  // Whether the user passed
  completedAt DateTime @default(now())

  @@index([userId])
  @@index([quizId])
  @@index([completedAt])
  @@map("quiz_attempts")
}

// LearningWallPost Model - Student reflections after completing lessons
model LearningWallPost {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId  String
  lesson    VideoLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  content   String   @db.Text // Student's reflection/learning

  // Relations
  likes     LearningWallLike[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([lessonId])
  @@index([createdAt])
  @@map("learning_wall_posts")
}

// LearningWallLike Model - Likes on learning wall posts
model LearningWallLike {
  id     String   @id @default(cuid())
  userId String
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  postId String
  post   LearningWallPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, postId]) // User can only like a post once
  @@index([userId])
  @@index([postId])
  @@map("learning_wall_likes")
}

// GameProgress Model - Tracks user progress in vocabulary games
model GameProgress {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Game identification
  gameName  String   // "synohit", "hopright", "wordstudyjournal"
  level     Int      // Level number (1, 2, or 3)

  // Progress tracking
  score     Int      // Score achieved (out of 10)
  completed Boolean  @default(false) // Whether level was completed with passing score

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, gameName, level]) // One progress record per user per game per level
  @@index([userId])
  @@index([gameName])
  @@index([userId, gameName])
  @@map("game_progress")
}
